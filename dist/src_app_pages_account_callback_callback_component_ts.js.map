{"version":3,"file":"src_app_pages_account_callback_callback_component_ts.js","mappings":"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","sources":["./src/app/pages/account/callback/callback.component.ts"],"sourcesContent":["import { Component, OnInit } from '@angular/core';\nimport { Router, ActivatedRoute } from '@angular/router';\nimport { fetchAuthSession, getCurrentUser } from 'aws-amplify/auth';\nimport { IonContent, IonSpinner, IonText } from '@ionic/angular/standalone';\nimport { Hub } from 'aws-amplify/utils';\n\n@Component({\n  selector: 'app-callback',\n  standalone: true,\n  imports: [\n    IonContent,\n    IonSpinner,\n    IonText\n  ],\n  template: `\n      <ion-content class=\"ion-padding\">\n        <div style=\"display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;\">\n          <ion-spinner color=\"primary\"></ion-spinner>\n          <ion-text color=\"primary\" style=\"margin-top: 20px;\">\n            <h3>Verifying your sign-in...</h3>\n            <p>Please wait while we complete your authentication.</p>\n          </ion-text>\n        </div>\n      </ion-content>`\n})\nexport class CallbackComponent implements OnInit {\n  private authCheckInterval: any;\n  private hubUnsubscribe: any;\n\n  constructor(\n    private router: Router,\n    private route: ActivatedRoute\n  ) {}\n\n  async ngOnInit() {\n    console.log('üîó OAuth callback component initialized');\n\n    // Set up Hub listener for auth events\n    this.hubUnsubscribe = Hub.listen('auth', async ({ payload }) => {\n      console.log('üîó Callback component received auth event:', payload.event);\n\n      if (payload.event === 'signInWithRedirect') {\n        console.log('‚úÖ OAuth sign-in complete! Redirecting to home...');\n        this.cleanup();\n        await this.router.navigate(['/home']);\n      } else if (payload.event === 'signInWithRedirect_failure') {\n        console.error('‚ùå OAuth sign-in failed:', payload.data);\n        this.cleanup();\n        await this.router.navigate(['/account/signup'], {\n          queryParams: { error: 'Authentication failed' }\n        });\n      }\n    });\n\n    // Always read from the full URL (works for iOS + Android)\n    const currentUrl = window.location.href;\n    const urlParams = new URL(currentUrl).searchParams;\n\n    // Fallback: Angular route snapshot (useful on web)\n    const routeParams = this.route.snapshot.queryParams;\n\n    const code = urlParams.get('code') || routeParams['code'];\n    const error = urlParams.get('error') || routeParams['error'];\n\n    console.log('üîó Callback URL:', currentUrl);\n    console.log('üîó OAuth code:', code ? 'present' : 'missing');\n    console.log('üîó OAuth error:', error || 'none');\n\n    if (error) {\n      console.error('üîó OAuth error received:', error);\n      this.cleanup();\n      this.router.navigate(['/account/signup'], {\n        queryParams: { error: 'OAuth authentication failed' }\n      });\n      return;\n    }\n\n    if (code) {\n      console.log('üîó Authorization code detected, waiting for Amplify to process...');\n      await this.waitForAuthentication();\n    } else {\n      console.warn('üîó No authorization code found in callback URL');\n      this.cleanup();\n      this.router.navigate(['/account/signup']);\n    }\n  }\n\n  ngOnDestroy() {\n    this.cleanup();\n  }\n\n  private cleanup() {\n    if (this.authCheckInterval) {\n      clearInterval(this.authCheckInterval);\n      this.authCheckInterval = null;\n    }\n    if (this.hubUnsubscribe) {\n      this.hubUnsubscribe();\n      this.hubUnsubscribe = null;\n    }\n  }\n\n  private async waitForAuthentication(): Promise<void> {\n    // Start checking auth status immediately and periodically\n    let attempts = 0;\n    const maxAttempts = 40; // 60 seconds total (40 * 1.5s)\n\n    // First, give Amplify a moment to process the OAuth callback\n    console.log('‚è≥ Waiting for Amplify OAuth listener to process callback...');\n    await new Promise(resolve => setTimeout(resolve, 2000));\n\n    return new Promise((resolve) => {\n      this.authCheckInterval = setInterval(async () => {\n        attempts++;\n        console.log(`üîó Checking authentication status (${attempts}/${maxAttempts})...`);\n\n        try {\n          // Force refresh every 3rd attempt to check if tokens are ready\n          const forceRefresh = attempts % 3 === 0;\n          const session = await fetchAuthSession({ forceRefresh });\n\n          console.log(`üîó Session check result:`, {\n            hasTokens: !!session.tokens,\n            hasIdToken: !!session.tokens?.idToken,\n            hasAccessToken: !!session.tokens?.accessToken,\n            forceRefresh\n          });\n\n          if (session.tokens?.idToken) {\n            console.log('‚úÖ Session tokens found! Verifying user...');\n\n            try {\n              // Verify user is actually authenticated\n              const user = await getCurrentUser();\n              console.log('‚úÖ User authenticated successfully!', {\n                userId: user.userId,\n                username: user.username\n              });\n\n              this.cleanup();\n              console.log('‚úÖ Redirecting to /home...');\n              await this.router.navigate(['/home']);\n              resolve();\n              return;\n            } catch (userErr: any) {\n              console.log('‚è≥ Tokens present but user not ready yet:', userErr.message || userErr);\n            }\n          } else {\n            console.log('‚è≥ No tokens found yet, continuing to wait...');\n          }\n        } catch (err: any) {\n          console.log(`‚è≥ Auth check failed (${attempts}/${maxAttempts}):`, {\n            message: err.message || err,\n            name: err.name,\n            code: err.code\n          });\n        }\n\n        // Timeout check\n        if (attempts >= maxAttempts) {\n          console.error('‚ùå Authentication timeout after', maxAttempts * 1.5, 'seconds');\n          console.error('‚ùå OAuth callback failed to complete. This may be due to:');\n          console.error('   1. Amplify OAuth listener not processing the authorization code');\n          console.error('   2. Redirect URI mismatch in AWS Cognito configuration');\n          console.error('   3. Network connectivity issues');\n\n          this.cleanup();\n          this.router.navigate(['/account/signup'], {\n            queryParams: { error: 'Authentication timeout. Please try again.' }\n          });\n          resolve();\n        }\n      }, 1500); // Check every 1.5 seconds\n    });\n  }\n}\n"],"names":["Component","Router","ActivatedRoute","fetchAuthSession","getCurrentUser","IonContent","IonSpinner","IonText","Hub","CallbackComponent","router","route","authCheckInterval","hubUnsubscribe","constructor","ngOnInit","_this","_asyncToGenerator","console","log","listen","_ref","payload","event","cleanup","navigate","error","data","queryParams","_x","apply","arguments","currentUrl","window","location","href","urlParams","URL","searchParams","routeParams","snapshot","code","get","waitForAuthentication","warn","ngOnDestroy","clearInterval","_this2","attempts","maxAttempts","Promise","resolve","setTimeout","setInterval","forceRefresh","session","hasTokens","tokens","hasIdToken","idToken","hasAccessToken","accessToken","user","userId","username","userErr","message","err","name","__decorate","selector","standalone","imports","template"],"sourceRoot":"webpack:///","x_google_ignoreList":[]}